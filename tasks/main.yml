---
# tasks file for diana-docker

#############################
# Setup dockerhost
#############################

- name: Get dockerhost
  shell: /sbin/ip route | awk '/docker0/ { print $NF }'
  register: dockerhost_response
  when: dockerhost_ip is not defined

- set_fact:
    dockerhost_ip:    "{{ dockerhost_response.stdout }}"
  when: dockerhost_ip is not defined


#############################
# Create config directories
#############################

- name: "Create {{ diana_config_dir }} directory for config"
  file:
    path: '{{ diana_config_dir }}'
    state: directory


#############################
# Setup container
#############################

- set_fact:
    broker_url: "redis://:{{ diana_redis_password }}@{{ dockerhost_ip }}:{{ diana_redis_port }}/{{ diana_broker_db }}"
    result_url: "redis://:{{ diana_redis_password }}@{{ dockerhost_ip }}:{{ diana_redis_port }}/{{ diana_result_db }}"

- docker_container:
    name:  "{{ diana_container_name }}"
    image: "{{ diana_docker_image }}:{{ diana_docker_tag }}"
    state: started
    command: "{{ diana_command }}"
    working_dir: "{{ diana_workdir }}"
    env:
      DIANA_BROKER:  "{{ broker_url }}"
      DIANA_RESULT:  "{{ result_url }}"
      TZ: America/New_York

    ports: "{{ diana_ports | default([]) }}"

    volumes:
      - "{{ diana_config_dir }}:/opt/diana/config"

    log_driver:   "{{ diana_logger }}"
    log_options:  "{{ diana_log_opts }}"
